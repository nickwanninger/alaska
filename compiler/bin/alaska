#!/usr/bin/bash

set -e

PFX=$(realpath "$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )/../")

export PATH=$PFX/bin:$PATH
export LD_LIBRARY_PATH=$PFX/lib:$LD_LIBRARY_PATH

OUTFILE="a.out"
KEEP="false"
BASELINE="false"
COLLECT_CLANG_ARGS=() INPUTS=() OPT_ARGS=()
OBJECT_TARGET=

SO="so"
if [ "$(uname)" == "Darwin" ]; then
	SO="dylib"
fi

phase="link"

while [[ $# -gt 0 ]]
do
    case $1 in
			-g*)
				shift
				;;
			-b|--baseline)
				BASELINE="true"
				shift
				;;
			-k|--keep-ir)
				KEEP="true"
				shift
				;;
			-o)
				OUTFILE="$2"
				shift
				shift
				COLLECT_CLANG_ARGS+=("-o $OUTFILE")
				;;
			-c)
				phase="compile"
				shift
				;;

			--alaska-*)
				OPT_ARGS+=("$1")
				shift
				;;
			*)
				COLLECT_CLANG_ARGS+=("$1")
				shift
				;;
    esac
done

COLLECT_CLANG_ARGS+=("-Xclang -disable-O0-optnone")
# COLLECT_CLANG_ARGS += ("-gdwarf-4 ")


ALASKA_LIBS=""
# ALASKA_LIBS+="-nostdlib ${PFX}/lib/libc.o ${PFX}/lib/libc.a "
ALASKA_LIBS+="${PFX}/lib/libalaska_core.a "
# ALASKA_LIBS+="-Wl,--whole-archive "
# ALASKA_LIBS+="${PFX}/lib/libalaska_support.a "
# ALASKA_LIBS+="-Wl,--no-whole-archive "
ALASKA_LIBS+="-Wl,-rpath=${PFX}/lib -Wl,-rpath-link=${PFX}/lib -L${PFX}/lib -lalaska_support -lunicorn"


GCLANG="${ALASKA_GCLANG:=gclang}"
CLANG="${ALASKA_CLANG:=clang}"

if [ "$phase" = "compile" ]; then
	$GCLANG -Wno-unused-command-line-argument -I${PFX}/include -c ${COLLECT_CLANG_ARGS[@]}
	exit
else
	# If the program is being linked, link it as the user requests, then
	# use get-bc to run our pass on it behind the scenes :)
	$GCLANG -pthread -lm -Wno-unused-command-line-argument -I${PFX}/include ${COLLECT_CLANG_ARGS[@]} ${ALASKA_LIBS}

	get-bc $OUTFILE >/dev/null
	[ "$BASELINE" == "true" ] && mv $OUTFILE $OUTFILE.base
	TMPFILE=${OUTFILE}.bc

	[ "$KEEP" == "true" ] && llvm-dis ${TMPFILE} -o ${OUTFILE}.in.ll
	$PFX/bin/alaska-transform ${TMPFILE} ${OPT_ARGS[@]}
	opt -enable-new-pm=0 ${TMPFILE} -o ${TMPFILE} --dce --adce
	# link the alaska bitcode file
	llvm-link -o ${TMPFILE} ${TMPFILE} ${PFX}/lib/alaska.bc
	opt -enable-new-pm=0 ${TMPFILE} -o ${TMPFILE} --inline --always-inline
	[ "$KEEP" == "true" ] && llvm-dis ${TMPFILE} -o ${OUTFILE}.out.ll

	$GCLANG -T "${PFX}/share/alaska/ldscripts/alaska-$(uname -m).ld" \
		 -O3 -gdwarf-4 -lm -ldl -pthread ${TMPFILE} ${ALASKA_LIBS} -o $OUTFILE

	rm ${TMPFILE}
fi

