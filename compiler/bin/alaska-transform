#!/usr/bin/env python3

import os
import sys
import argparse
import tempfile
import shutil
from pathlib import Path

local = Path(os.path.realpath(os.path.dirname(__file__))).parent
os.environ["PATH"] = f"{local}/bin:{os.environ['PATH']}"
os.environ["LD_LIBRARY_PATH"] = f"{local}/lib:{os.environ['LD_LIBRARY_PATH']}"

print(local)


parser = argparse.ArgumentParser(prog='alaska-transform', description='Applies alaska transformations to an input bitcode')


parser.add_argument('-o', dest='output', help='The destination file. Defaults to in-place.')
parser.add_argument('-b', '--baseline', action='store_true', help='Apply baseline transformations, do not insert translations')
parser.add_argument('input', help='The input .bc file to apply alaska transformations to.')

args = parser.parse_args()
print(sys.argv)
print(args)

if args.output is None:
  args.output = args.input


bitcode = args.output

def exec(cmd):
  print(cmd)
  res = os.system(cmd)
  if res != 0:
    exit()

tempdir = tempfile.mkdtemp(prefix='alaska_')

print(tempdir)


# exec(f'llvm-link {local}/lib/alaska_stub.bc {local}/lib/alaska_translate.bc -o {tempdir}/lib.bc')
exec(f'opt --strip-debug {local}/lib/alaska_stub.bc -o {tempdir}/stub.bc')
exec(f'opt --strip-debug {local}/lib/alaska_translate.bc -o {tempdir}/translate.bc')
# exec(f'opt --strip-debug {tempdir}/lib.bc -o {tempdir}/lib.bc')

if not args.baseline:
  exec(f'llvm-link {args.input} --internalize {tempdir}/stub.bc -o {bitcode}')
else:
  shutil.copy(args.input, bitcode)

def run_passes(passes):
  for p in passes:
    before = f'{tempdir}/before-{p}.bc'
    after = f'{tempdir}/after-{p}.bc'
    shutil.copy(bitcode, before)
    exec(f'opt --load-pass-plugin={local}/lib/Alaska.so --passes={p} {before} -o {after}')
    shutil.copy(after, bitcode)


passes = []


exec(f'opt {bitcode} -o {bitcode} -lowerswitch -basic-aa -mergereturn --break-crit-edges -loop-simplify -lcssa -indvars -mem2reg -simplifycfg-sink-common=false -licm -instnamer')


run_passes(['alaska-prepare'])

# Now add the passes in the order they need to be (if we aren't compiling for baseline)
if not args.baseline:
  run_passes(['alaska-replace', 'alaska-translate'])
  # run_passes(['alaska-translate'])
  exec(f'llvm-link {bitcode} --internalize {tempdir}/translate.bc -o {bitcode}')
  passes.append('alaska-escape')

  passes.append('alaska-tracking')
  passes.append('alaska-lower')
  passes.append('alaska-inline')

run_passes(passes)
exec(f'llvm-dis {args.output}')
